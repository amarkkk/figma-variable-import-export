<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, sans-serif; font-size: 12px; background: #fff; color: #000; overflow: hidden; }
.container { height: 100vh; display: flex; flex-direction: column; }
.tabs { display: flex; border-bottom: 1px solid #e5e5e5; background: #f5f5f5; }
.tab { padding: 12px 24px; cursor: pointer; border: none; background: transparent; font-size: 13px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab:hover { color: #000; background: #ebebeb; }
.tab.active { color: #000; border-bottom-color: #0d99ff; background: #fff; }
.tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; }
.tab-content.active { display: flex; }
.toolbar { padding: 12px 16px; background: #f9f9f9; border-bottom: 1px solid #e5e5e5; display: flex; gap: 8px; align-items: center; }
.search-box { flex: 1; padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.btn { padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
.btn:hover { background: #f5f5f5; }
.btn-primary { background: #0d99ff; color: white; border-color: #0d99ff; }
.btn-primary:hover { background: #0b7fd9; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-success { background: #28a745; color: white; border-color: #28a745; }
.btn-success:hover { background: #218838; }
.table-container { flex: 1; overflow-y: auto; border-bottom: 1px solid #e5e5e5; }
.collection-group { border-bottom: 1px solid #e5e5e5; }
.collection-header { padding: 12px 16px; background: #f5f5f5; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
.collection-header:hover { background: #ebebeb; }
.variable-row { padding: 10px 16px 10px 40px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
.variable-row:hover { background: #f9f9f9; }
.variable-row.selected { background: #e3f2ff; }
.variable-row.alias { opacity: 0.5; pointer-events: none; }
.checkbox { width: 16px; height: 16px; cursor: pointer; }
.variable-info { flex: 1; min-width: 0; }
.variable-name { font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
.badge { padding: 2px 6px; background: #ffc107; border-radius: 3px; font-size: 9px; font-weight: 600; }
.variable-desc { color: #666; font-size: 11px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.variable-type { padding: 2px 8px; background: #e5e5e5; border-radius: 3px; font-size: 10px; font-weight: 500; color: #666; }
.footer { padding: 12px 16px; background: #f9f9f9; border-top: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center; }
.selection-info { color: #666; font-size: 12px; }
.export-buttons { display: flex; gap: 8px; }
.helper-text { color: #666; font-size: 11px; margin-top: 8px; padding: 8px 12px; background: #f0f9ff; border-left: 3px solid #0d99ff; border-radius: 3px; line-height: 1.5; }
.import-container { flex: 1; display: flex; flex-direction: column; padding: 16px; gap: 16px; overflow-y: auto; }
.import-method { border: 2px solid #e5e5e5; border-radius: 8px; padding: 20px; transition: all 0.2s; }
.import-method.clickable { cursor: pointer; }
.import-method.clickable:hover { border-color: #0d99ff; background: #f9fcff; }
.import-method h3 { font-size: 14px; margin-bottom: 8px; }
.import-method p { color: #666; font-size: 11px; line-height: 1.5; margin-bottom: 12px; }
.file-upload { border: 2px dashed #ccc; border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s; margin-top: 12px; }
.file-upload:hover { border-color: #0d99ff; background: #f9fcff; }
.file-upload.drag-over { border-color: #0d99ff; background: #e3f2ff; }
.alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; display: flex; gap: 8px; }
.alert-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
.alert-error { background: #f8d7da; border: 1px solid #dc3545; color: #721c24; }
.alert-success { background: #d4edda; border: 1px solid #28a745; color: #155724; }
.validation-summary { background: #f9f9f9; border: 1px solid #e5e5e5; border-radius: 6px; padding: 16px; margin-bottom: 16px; }
.validation-summary h3 { margin-bottom: 12px; font-size: 14px; }
.validation-item { padding: 8px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
.validation-item:last-child { border-bottom: none; }
.preview-list { max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #e5e5e5; border-radius: 6px; padding: 12px; }
.preview-item { padding: 8px; margin-bottom: 8px; background: #f9f9f9; border-left: 3px solid #0d99ff; border-radius: 3px; }
.preview-item-header { font-weight: 600; margin-bottom: 4px; font-size: 12px; }
.preview-change { font-size: 11px; color: #666; margin-left: 12px; margin-top: 2px; }
.hidden { display: none; }
.loading { text-align: center; padding: 32px; color: #666; }
.future-badge { position: absolute; top: 10px; right: 10px; background: #ffc107; color: #000; padding: 4px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; }
</style>
</head>
<body>
<div class="container">
<div class="tabs">
<button class="tab active" data-tab="export">Export Variables</button>
<button class="tab" data-tab="import">Import Variables</button>
</div>

<!-- Export Tab -->
<div class="tab-content active" id="export-tab">
<div class="toolbar">
<input type="text" class="search-box" placeholder="Search variables..." id="search-export">
<button class="btn" id="select-all-btn">Select All</button>
<button class="btn" id="deselect-all-btn">Deselect All</button>
<button class="btn" id="refresh-btn">Refresh</button>
</div>
<div class="table-container" id="variables-list"><div class="loading">Loading variables...</div></div>
<div class="footer">
<div style="flex: 1;">
<div class="selection-info" id="selection-info">0 variables selected (0 foundational)</div>
<div class="helper-text">
ðŸ’¡ <strong>Google Sheets Workflow:</strong> Import CSVs to Google Sheets (each as a separate tab), edit values, then download and re-upload to sync. CSV files are named after collections for easy organization.
</div>
</div>
<div class="export-buttons">
<button class="btn btn-success" id="export-csv-btn" disabled>ðŸ“Š Export to CSV</button>
<button class="btn btn-primary" id="export-json-btn" disabled>ðŸ“„ Export to JSON</button>
</div>
</div>
</div>

<!-- Import Tab -->
<div class="tab-content" id="import-tab">
<div class="import-container">
<div id="import-methods">
<h2 style="margin-bottom: 16px; font-size: 16px;">Choose Import Method</h2>

<!-- CSV Upload Method -->
<div class="import-method clickable">
<h3>ðŸ“Š Upload CSV File (Recommended)</h3>
<p>Upload a CSV file exported from this plugin or created from the template.</p>
<div class="file-upload" id="csv-upload">
<div style="font-size: 36px; margin-bottom: 8px;">ðŸ“„</div>
<div style="font-weight: 600; margin-bottom: 4px;">Drop CSV file here or click to browse</div>
<input type="file" id="csv-file-input" accept=".csv" style="display: none;">
</div>
</div>

<!-- JSON Upload Method -->
<div class="import-method clickable" style="margin-top: 16px;">
<h3>ðŸ“‹ Upload JSON File (Backup Method)</h3>
<p>Upload a JSON file exported from this plugin with full variable data.</p>
<div class="file-upload" id="json-upload">
<div style="font-size: 36px; margin-bottom: 8px;">ðŸ“‹</div>
<div style="font-weight: 600; margin-bottom: 4px;">Drop JSON file here or click to browse</div>
<input type="file" id="json-file-input" accept=".json" style="display: none;">
</div>
</div>

<!-- Future Feature: Google Sheets -->
<div class="import-method" style="margin-top: 24px; opacity: 0.6; position: relative; border-color: #999;">
<div class="future-badge">FUTURE FEATURE</div>
<h3>ðŸ”— Direct Google Sheets Sync</h3>
<p>We explored auto-syncing from Google Sheets URLs, but Google's CORS policies currently prevent this from working in Figma plugins.</p>
<input type="text" placeholder="https://docs.google.com/spreadsheets/d/..." disabled style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; margin-bottom: 8px; background: #f5f5f5; cursor: not-allowed; color: #999;">
<button class="btn" disabled style="cursor: not-allowed; opacity: 0.5; width: 100%;">Sync from URL (Not Available)</button>
<div class="helper-text" style="margin-top: 12px; background: #fff3cd; border-left-color: #ffc107;">
ðŸ’¡ <strong>Have a workaround idea?</strong> We'd love to make this work! If you have suggestions for implementing direct Google Sheets sync, please reach out:<br>
<a href="https://github.com/yourusername/variable-import-export/issues" target="_blank" style="color: #0d99ff; text-decoration: none;">Open a GitHub issue</a> or email us with your ideas.
</div>
</div>
</div>

<!-- Validation Results -->
<div id="validation-results" class="hidden"></div>

<!-- Import Footer -->
<div class="footer hidden" id="import-footer" style="margin-top: auto;">
<div></div>
<div style="display: flex; gap: 8px;">
<button class="btn" id="cancel-import-btn">Cancel</button>
<button class="btn btn-primary" id="confirm-import-btn">Confirm Import</button>
</div>
</div>
</div>
</div>
</div>

<script>
let collections = [];
let selectedVariables = new Set();
let importData = null;
let importType = null;

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
    if (tab.dataset.tab === 'export') {
      parent.postMessage({ pluginMessage: { type: 'scan-collections' } }, '*');
    }
  });
});

parent.postMessage({ pluginMessage: { type: 'scan-collections' } }, '*');

document.getElementById('refresh-btn').addEventListener('click', () => {
  parent.postMessage({ pluginMessage: { type: 'scan-collections' } }, '*');
});

document.getElementById('select-all-btn').addEventListener('click', () => {
  collections.forEach(col => {
    col.variables.forEach(v => { if (!v.isAlias) selectedVariables.add(v.id); });
  });
  renderVariablesList();
  updateSelectionInfo();
});

document.getElementById('deselect-all-btn').addEventListener('click', () => {
  selectedVariables.clear();
  renderVariablesList();
  updateSelectionInfo();
});

document.getElementById('search-export').addEventListener('input', (e) => {
  renderVariablesList(e.target.value.toLowerCase());
});

document.getElementById('export-csv-btn').addEventListener('click', () => {
  const collectionIds = [...new Set(collections.filter(c => c.variables.some(v => selectedVariables.has(v.id))).map(c => c.id))];
  parent.postMessage({ pluginMessage: { type: 'export-csv', collectionIds, variableIds: Array.from(selectedVariables) } }, '*');
});

document.getElementById('export-json-btn').addEventListener('click', () => {
  const collectionIds = [...new Set(collections.filter(c => c.variables.some(v => selectedVariables.has(v.id))).map(c => c.id))];
  parent.postMessage({ pluginMessage: { type: 'export-json', collectionIds, variableIds: Array.from(selectedVariables) } }, '*');
});

// CSV upload
const csvUpload = document.getElementById('csv-upload');
const csvFileInput = document.getElementById('csv-file-input');
csvUpload.addEventListener('click', () => csvFileInput.click());
csvFileInput.addEventListener('change', (e) => {
  if (e.target.files[0]) handleCSVUpload(e.target.files[0]);
});
csvUpload.addEventListener('dragover', (e) => {
  e.preventDefault();
  csvUpload.classList.add('drag-over');
});
csvUpload.addEventListener('dragleave', () => csvUpload.classList.remove('drag-over'));
csvUpload.addEventListener('drop', (e) => {
  e.preventDefault();
  csvUpload.classList.remove('drag-over');
  if (e.dataTransfer.files[0]?.name.endsWith('.csv')) {
    handleCSVUpload(e.dataTransfer.files[0]);
  }
});

// JSON upload
const jsonUpload = document.getElementById('json-upload');
const jsonFileInput = document.getElementById('json-file-input');
jsonUpload.addEventListener('click', () => jsonFileInput.click());
jsonFileInput.addEventListener('change', (e) => {
  if (e.target.files[0]) handleJSONUpload(e.target.files[0]);
});
jsonUpload.addEventListener('dragover', (e) => {
  e.preventDefault();
  jsonUpload.classList.add('drag-over');
});
jsonUpload.addEventListener('dragleave', () => jsonUpload.classList.remove('drag-over'));
jsonUpload.addEventListener('drop', (e) => {
  e.preventDefault();
  jsonUpload.classList.remove('drag-over');
  if (e.dataTransfer.files[0]?.name.endsWith('.json')) {
    handleJSONUpload(e.dataTransfer.files[0]);
  }
});

document.getElementById('cancel-import-btn').addEventListener('click', resetImportState);
document.getElementById('confirm-import-btn').addEventListener('click', () => {
  if (importData && importType) {
    parent.postMessage({ pluginMessage: { 
      type: importType === 'csv' ? 'import-csv' : 'import-json',
      [importType === 'csv' ? 'csvData' : 'jsonData']: importData
    } }, '*');
  }
});

function handleCSVUpload(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    importData = e.target.result;
    importType = 'csv';
    parent.postMessage({ pluginMessage: { type: 'validate-csv-import', csvData: importData } }, '*');
    hideImportMethods();
    showValidationLoading();
  };
  reader.readAsText(file);
}

function handleJSONUpload(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    importData = e.target.result;
    importType = 'json';
    parent.postMessage({ pluginMessage: { type: 'validate-json-import', jsonData: importData } }, '*');
    hideImportMethods();
    showValidationLoading();
  };
  reader.readAsText(file);
}

function renderVariablesList(searchTerm = '') {
  const container = document.getElementById('variables-list');
  if (collections.length === 0) {
    container.innerHTML = '<div class="loading">No variable collections found</div>';
    return;
  }
  let html = '';
  collections.forEach(collection => {
    const filteredVars = collection.variables.filter(v => !searchTerm || v.name.toLowerCase().includes(searchTerm) || (v.description && v.description.toLowerCase().includes(searchTerm)));
    if (filteredVars.length === 0 && searchTerm) return;
    const foundationalVars = filteredVars.filter(v => !v.isAlias);
    const allSelected = foundationalVars.every(v => selectedVariables.has(v.id));
    html += '<div class="collection-group"><div class="collection-header" onclick="toggleCollection(\'' + collection.id + '\')"><input type="checkbox" class="checkbox" ' + (allSelected && foundationalVars.length > 0 ? 'checked' : '') + ' onclick="toggleCollectionSelection(event, \'' + collection.id + '\')" data-collection-id="' + collection.id + '"><span style="flex: 1;">' + collection.name + '</span><span style="color: #666; font-size: 11px;">' + foundationalVars.length + ' foundational / ' + filteredVars.length + ' total</span><span id="chevron-' + collection.id + '">â–¼</span></div><div id="variables-' + collection.id + '" style="display: block;">';
    filteredVars.forEach(variable => {
      const isSelected = selectedVariables.has(variable.id);
      const isDisabled = variable.isAlias;
      html += '<div class="variable-row ' + (isSelected ? 'selected' : '') + ' ' + (isDisabled ? 'alias' : '') + '" onclick="' + (!isDisabled ? "toggleVariableSelection('" + variable.id + "')" : '') + '"><input type="checkbox" class="checkbox" ' + (isSelected ? 'checked' : '') + ' ' + (isDisabled ? 'disabled' : '') + ' onclick="event.stopPropagation()"><div class="variable-info"><div class="variable-name">' + variable.name + (variable.isAlias ? '<span class="badge">ALIAS</span>' : '') + '</div>' + (variable.description ? '<div class="variable-desc">' + variable.description + '</div>' : '') + '</div><div class="variable-type">' + variable.resolvedType + '</div></div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
}

window.toggleCollection = function(collectionId) {
  const div = document.getElementById('variables-' + collectionId);
  const chevron = document.getElementById('chevron-' + collectionId);
  if (div.style.display === 'none') {
    div.style.display = 'block';
    chevron.textContent = 'â–¼';
  } else {
    div.style.display = 'none';
    chevron.textContent = 'â–¶';
  }
};

window.toggleCollectionSelection = function(event, collectionId) {
  event.stopPropagation();
  const collection = collections.find(c => c.id === collectionId);
  if (!collection) return;
  const foundationalVars = collection.variables.filter(v => !v.isAlias);
  const allSelected = foundationalVars.every(v => selectedVariables.has(v.id));
  if (allSelected) {
    foundationalVars.forEach(v => selectedVariables.delete(v.id));
  } else {
    foundationalVars.forEach(v => selectedVariables.add(v.id));
  }
  renderVariablesList();
  updateSelectionInfo();
};

window.toggleVariableSelection = function(variableId) {
  if (selectedVariables.has(variableId)) {
    selectedVariables.delete(variableId);
  } else {
    selectedVariables.add(variableId);
  }
  renderVariablesList();
  updateSelectionInfo();
};

function updateSelectionInfo() {
  const count = selectedVariables.size;
  const foundationalCount = Array.from(selectedVariables).filter(id => {
    for (const col of collections) {
      const variable = col.variables.find(v => v.id === id);
      if (variable && !variable.isAlias) return true;
    }
    return false;
  }).length;
  document.getElementById('selection-info').textContent = count + ' variable' + (count !== 1 ? 's' : '') + ' selected (' + foundationalCount + ' foundational)';
  document.getElementById('export-csv-btn').disabled = foundationalCount === 0;
  document.getElementById('export-json-btn').disabled = foundationalCount === 0;
}

function hideImportMethods() {
  document.getElementById('import-methods').style.display = 'none';
}

function showValidationLoading() {
  const container = document.getElementById('validation-results');
  container.classList.remove('hidden');
  container.innerHTML = '<div class="loading">Validating import data...</div>';
}

function resetImportState() {
  importData = null;
  importType = null;
  document.getElementById('import-methods').style.display = 'block';
  document.getElementById('validation-results').classList.add('hidden');
  document.getElementById('validation-results').innerHTML = '';
  document.getElementById('import-footer').classList.add('hidden');
  csvFileInput.value = '';
  jsonFileInput.value = '';
}

function downloadCSVSheets(data) {
  Object.values(data).forEach(collection => {
    const csv = convertToCSV(collection.data);
    downloadFile(csv, collection.name + '.csv', 'text/csv');
  });
  alert('CSV export successful! ' + Object.keys(data).length + ' collection(s) exported.');
}

function convertToCSV(data) {
  if (data.length === 0) return '';
  const headers = Object.keys(data[0]);
  const csvRows = [headers.map(h => '"' + h + '"').join(',')];
  data.forEach(row => {
    const values = headers.map(h => '"' + String(row[h] || '').replace(/"/g, '""') + '"');
    csvRows.push(values.join(','));
  });
  return csvRows.join('\n');
}

// FIXED: Mac-compatible download function
function downloadFile(content, filename, mimeType) {
  try {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    
    // Critical for Mac: Must append to DOM before clicking
    document.body.appendChild(a);
    a.click();
    
    // Delay cleanup to ensure download starts (especially important on Mac)
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  } catch (error) {
    console.error('Download failed:', error);
    alert('Download failed. Error: ' + error.message);
  }
}

window.onmessage = (event) => {
  const msg = event.data.pluginMessage;
  if (msg.type === 'collections-scanned') {
    collections = msg.collections;
    renderVariablesList();
    updateSelectionInfo();
  } else if (msg.type === 'csv-export-ready') {
    downloadCSVSheets(msg.data);
  } else if (msg.type === 'json-export-ready') {
    downloadFile(msg.data, 'figma-variables-' + new Date().toISOString().split('T')[0] + '.json', 'application/json');
    alert('JSON export successful!');
  } else if (msg.type === 'csv-validation-result') {
    renderCSVValidation(msg.validation);
  } else if (msg.type === 'json-validation-result') {
    renderJSONValidation(msg.validation);
  } else if (msg.type === 'csv-import-complete') {
    renderImportResults(msg.results, 'CSV');
  } else if (msg.type === 'json-import-complete') {
    renderImportResults(msg.results, 'JSON');
  } else if (msg.type === 'error') {
    alert('Error: ' + msg.message);
  }
};

function renderCSVValidation(v) {
  const c = document.getElementById('validation-results');
  let h = '';
  if (v.errors?.length > 0) {
    h += '<div class="alert alert-error"><div style="flex: 1;"><strong>Errors:</strong><ul style="margin: 8px 0 0 20px;">';
    v.errors.forEach(e => h += '<li>' + e + '</li>');
    h += '</ul></div></div>';
  }
  if (v.warnings?.length > 0) {
    h += '<div class="alert alert-warning"><div style="flex: 1;"><strong>Warnings:</strong><ul style="margin: 8px 0 0 20px;">';
    v.warnings.forEach(w => h += '<li>' + w + '</li>');
    h += '</ul></div></div>';
  }
  if (v.valid && v.summary) {
    h += '<div class="validation-summary"><h3>Import Summary</h3>';
    h += '<div class="validation-item"><span>Variables to update:</span><strong>' + v.summary.variablesToUpdate + '</strong></div>';
    h += '<div class="validation-item"><span>Variables not found:</span><strong>' + v.summary.variablesNotFound + '</strong></div>';
    h += '<div class="validation-item"><span>Modes found:</span><strong>' + v.summary.modesFound.join(', ') + '</strong></div>';
    h += '</div>';
    if (v.preview?.length > 0) {
      h += '<h3 style="margin: 16px 0 8px 0; font-size: 14px;">Changes Preview:</h3><div class="preview-list">';
      v.preview.forEach(item => {
        h += '<div class="preview-item"><div class="preview-item-header">' + item.collectionName + ' / ' + item.variableName + '</div>';
        item.changes.forEach(change => h += '<div class="preview-change">â€¢ ' + change + '</div>');
        h += '</div>';
      });
      h += '</div>';
      document.getElementById('import-footer').classList.remove('hidden');
    }
  }
  if (!v.valid) {
    h += '<div class="alert alert-error">Import validation failed. Please fix the errors above.</div>';
    h += '<button class="btn" onclick="resetImportState()" style="margin-top: 12px;">Back</button>';
  }
  c.innerHTML = h;
}

function renderJSONValidation(v) {
  const c = document.getElementById('validation-results');
  let h = '';
  if (v.errors?.length > 0) {
    h += '<div class="alert alert-error"><div style="flex: 1;"><strong>Errors:</strong><ul style="margin: 8px 0 0 20px;">';
    v.errors.forEach(e => h += '<li>' + e + '</li>');
    h += '</ul></div></div>';
  }
  if (v.warnings?.length > 0) {
    h += '<div class="alert alert-warning"><div style="flex: 1;"><strong>Warnings:</strong><ul style="margin: 8px 0 0 20px;">';
    v.warnings.forEach(w => h += '<li>' + w + '</li>');
    h += '</ul></div></div>';
  }
  if (v.valid && v.summary) {
    h += '<div class="validation-summary"><h3>Import Summary</h3>';
    h += '<div class="validation-item"><span>Variables to update:</span><strong>' + v.summary.variablesToUpdate + '</strong></div